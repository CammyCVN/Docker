
FROM ruby:3.0

# Install system dependencies
RUN apt-get update && apt-get install -y \
    build-essential \
    libpq-dev \
    nodejs \
    nginx \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Install Passenger
RUN gem install passenger -v 6.0.18

# Set working directory
WORKDIR /app

# Copy application files
COPY Gemfile Gemfile.lock /app/
COPY . /app/

# Install Bundler and gems
RUN gem install bundler -v 2.3.3 && \
    bundle config set --global path 'vendor/bundle' && \
    bundle config set --global allow-root true && \
    bundle install --jobs 4 --retry 3

# Configure Nginx with Passenger
RUN passenger-install-nginx-module --auto --languages ruby

# Expose ports
EXPOSE 80

# Start Passenger + Nginx
CMD ["passenger", "start", "--port", "80", "--environment", "production"]
